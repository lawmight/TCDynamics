---
description: Unit and component testing patterns
globs: ["**/*.test.{ts,tsx}", "**/__tests__/**"]
---

# Unit Testing Patterns

## Test Structure
Use descriptive describe/it blocks:

```typescript
describe('Contact Component', () => {
  it('should render contact form', () => {
    render(<Contact />)
    expect(screen.getByText(/Contactez-nous/i)).toBeInTheDocument()
  })

  it('should validate required fields', async () => {
    render(<Contact />)
    fireEvent.click(screen.getByText(/Envoyer/i))

    await waitFor(() => {
      expect(emailInput.validity.valid).toBe(false)
    })
  })
})
```

## React Query Wrapper
Wrap components using React Query:

```typescript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: { retry: false },
    mutations: { retry: false },
  },
})

const Wrapper = ({ children }) => (
  <QueryClientProvider client={queryClient}>
    {children}
  </QueryClientProvider>
)
```

## Multiple Elements
Use `getAllBy*` for elements appearing multiple times:

```typescript
expect(screen.getAllByText(/Email/i).length).toBeGreaterThan(0)
```

## Test runner

- **Backend** (`apps/backend`): Jest — use `jest.mock` and `require` in mocks.
- **Frontend** (`apps/frontend`): Vitest — use `vi.mock` and `import`; mocks must be hoisted (top-level) or use `vi.hoisted`.

## Mocking Dependencies
Mock before imports:

**Jest (backend):**

```javascript
jest.mock('../../config/email', () => ({
  createTransporter: jest.fn(),
  emailTemplates: { demo: jest.fn() },
}))

// Import AFTER mocks
const { createTransporter } = require('../../config/email')
```

**Vitest (frontend):**

```typescript
vi.mock('@/utils/logger', () => ({ logger: { error: vi.fn(), warn: vi.fn() } }))
import { useFormSubmit } from '../useFormSubmit'
```
