---
description: Vercel serverless function patterns
globs: ["api/**/*.js"]
---

# Vercel Serverless Function Patterns

## ESM Module Structure
Use ES modules with `.js` extension for Vercel functions:

```javascript
import { connectToDatabase } from './_lib/mongodb.js'
import { verifyClerkAuth } from './_lib/auth.js'
import { withGuards } from './_lib/request-guards.js'
import { withSentry } from './_lib/sentry.js'

export const config = {
  api: {
    bodyParser: false, // Handle manually for size limits
  },
}

async function handler(req, res, body) {
  // Handler implementation
}

export default withSentry(withGuards(handler, options))
```

## Clerk Auth Verification
Use the standardized auth verification pattern:

```javascript
import { verifyClerkAuth } from './_lib/auth.js'

const { userId: clerkId, error } = await verifyClerkAuth(req.headers.authorization)

if (error) {
  return res.status(401).json({
    success: false,
    error: 'Unauthorized',
    message: error
  })
}
```

## Error Handling & Response Format
Consistent error handling with request tracing:

```javascript
try {
  // Handler logic
  res.status(200).json({
    success: true,
    message: 'Operation completed',
    data: result,
    requestId: req.requestId,
  })
} catch (error) {
  console.error('Handler error:', { requestId: req.requestId, error })
  res.status(500).json({
    success: false,
    error: 'Server error',
    message: error.message,
    requestId: req.requestId,
  })
}
```

## Request Guards Configuration
Use `withGuards` HOF for common protections:

```javascript
export default withGuards(handler, {
  allowedMethods: ['POST'],
  allowedFields: ['name', 'email', 'message'],
  requireCaptcha: true,
  rateLimit: {
    limit: 5,
    windowMs: 15 * 60 * 1000,
    scope: 'forms',
  },
  maxBodyBytes: 64 * 1024,
})
```

## Input Validation Pattern
Validate required fields with clear error messages:

```javascript
if (!name || !email || !message) {
  return res.status(400).json({
    error: 'Champs requis manquants',
    message: 'Veuillez remplir tous les champs obligatoires.',
    required: ['name', 'email', 'message'],
  })
}

// Email validation
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
const sanitizedEmail = email.trim()
if (!emailRegex.test(sanitizedEmail)) {
  return res.status(400).json({
    error: 'Format email invalide',
    message: 'Veuillez entrer une adresse email valide.',
  })
}
```

## CORS Headers
CORS is handled by Vercel configuration, but for custom needs:

```javascript
res.setHeader('Access-Control-Allow-Origin', '*')
res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS')
res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization')

if (req.method === 'OPTIONS') {
  return res.status(200).end()
}
```

## Shared Utilities Location
Store shared utilities in `api/_lib/`:
- `auth.js` - Clerk JWT verification (`verifyClerkAuth`)
- `mongodb.js` - MongoDB connection singleton
- `models/` - Mongoose schema definitions
- `email.js` - Email notification helpers
- `request-guards.js` - Request validation HOF
- `sentry.js` - Error monitoring wrapper
- `cache.js` - Response caching utilities
