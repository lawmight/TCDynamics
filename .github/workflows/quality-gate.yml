name: 'Quality Gate'

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_call:

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            apps/frontend/package-lock.json
            api/package-lock.json

      - name: Install root dependencies
        run: npm install

      - name: Install frontend dependencies
        working-directory: ./apps/frontend
        run: npm install

      - name: Type Check
        working-directory: ./apps/frontend
        run: npm run type-check

      - name: Lint
        working-directory: ./apps/frontend
        run: npm run lint

      - name: Unit Tests
        working-directory: ./apps/frontend
        run: npm run test:coverage

      - name: Assert health endpoint non-cacheable
        run: |
          if grep -q "Cache-Control" apps/backend/src/app.ts; then
            if ! grep -q "no-store" apps/backend/src/app.ts; then
              echo "❌ /health must include no-store Cache-Control"
              exit 1
            fi
            if grep -q "stale-while-revalidate" apps/backend/src/app.ts; then
              echo "❌ /health must not include stale-while-revalidate"
              exit 1
            fi
            echo "✅ /health Cache-Control is non-cacheable"
          else
            echo "ℹ️ No Cache-Control header found for /health"
          fi

      - name: Check Coverage Threshold
        working-directory: ./apps/frontend
        run: |
          # Check if coverage meets threshold using Node.js (no external dependencies needed)
          # Coverage report is generated by the Unit Tests step above
          # Current threshold: 60%
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const coverage = data.total.lines.pct;
            const threshold = 60;
            if (coverage < threshold) {
              console.error(\`❌ Coverage \${coverage}% is below \${threshold}% threshold\`);
              process.exit(1);
            } else {
              console.log(\`✅ Coverage \${coverage}% meets \${threshold}% threshold\`);
            }
          "

      - name: Build Check
        working-directory: ./apps/frontend
        run: npm run build

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./apps/frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

      # API Serverless Functions Validation
      - name: Install API dependencies
        working-directory: ./api
        run: npm install

      - name: Validate API ESM syntax
        working-directory: ./api
        run: |
          # Check that all .js files use ESM syntax (no CommonJS)
          # Exclude node_modules
          failed=0
          while IFS= read -r file; do
            if grep -q "require(" "$file" 2>/dev/null || grep -q "module.exports" "$file" 2>/dev/null; then
              echo "❌ $file contains CommonJS syntax (require or module.exports)"
              echo "   All API files must use ESM (import/export) syntax"
              failed=1
            fi
          done < <(find . -name "*.js" -not -path "./node_modules/*")

          if [ $failed -eq 1 ]; then
            exit 1
          fi
          echo "✅ All API files use ESM syntax"

      - name: Check API file structure
        working-directory: ./api
        run: |
          # Verify critical API files exist
          required_files=(
            "health.js"
            "chat.js"
            "contactform.js"
            "create-payment-intent.js"
            "create-subscription.js"
            "stripe/webhook.js"
            "stripe/create-checkout-session.js"
            "_lib/cache.js"
            "_lib/supabase.js"
            "_lib/email.js"
          )

          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done

          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "❌ Missing required API files:"
            printf '  - %s\n' "${missing_files[@]}"
            exit 1
          fi

          echo "✅ All required API files present"
