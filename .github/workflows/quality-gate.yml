name: 'Quality Gate'

on:
  pull_request:
    branches: [main]
    paths:
      - 'apps/frontend/**'
      - 'api/**'
      - '.github/workflows/quality-gate.yml'
  push:
    branches: [main]
    paths:
      - 'apps/frontend/**'
      - 'api/**'
      - '.github/workflows/quality-gate.yml'
  workflow_call:
    inputs:
      skip_lint:
        description: 'Skip linting checks'
        required: false
        type: boolean
        default: false
      skip_tests:
        description: 'Skip test execution'
        required: false
        type: boolean
        default: false
      skip_build:
        description: 'Skip build check'
        required: false
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      skip_lint:
        description: 'Skip linting checks'
        required: false
        type: boolean
        default: false
      skip_tests:
        description: 'Skip test execution'
        required: false
        type: boolean
        default: false
      skip_build:
        description: 'Skip build check'
        required: false
        type: boolean
        default: false

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20, 22]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js with Caching
        uses: ./.github/actions/setup-node-cache
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install Dependencies
        uses: ./.github/actions/install-dependencies
        with:
          node-version: ${{ matrix.node-version }}

      - name: Type Check
        if: (inputs.skip_lint != true && inputs.skip_lint != 'true') && (github.event.inputs.skip_lint != true && github.event.inputs.skip_lint != 'true')
        working-directory: ./apps/frontend
        run: npm run type-check

      - name: Lint
        if: (inputs.skip_lint != true && inputs.skip_lint != 'true') && (github.event.inputs.skip_lint != true && github.event.inputs.skip_lint != 'true')
        working-directory: ./apps/frontend
        run: npm run lint

      - name: Unit Tests
        if: (inputs.skip_tests != true && inputs.skip_tests != 'true') && (github.event.inputs.skip_tests != true && github.event.inputs.skip_tests != 'true')
        working-directory: ./apps/frontend
        run: npm run test:coverage
        id: test-run

      - name: Assert health endpoint non-cacheable
        run: |
          if grep -q "Cache-Control" apps/backend/src/app.ts; then
            if ! grep -q "no-store" apps/backend/src/app.ts; then
              echo "❌ /health must include no-store Cache-Control"
              exit 1
            fi
            if grep -q "stale-while-revalidate" apps/backend/src/app.ts; then
              echo "❌ /health must not include stale-while-revalidate"
              exit 1
            fi
            echo "✅ /health Cache-Control is non-cacheable"
          else
            echo "ℹ️ No Cache-Control header found for /health"
          fi

      - name: Check Coverage Threshold
        if: (inputs.skip_tests != true && inputs.skip_tests != 'true') && (github.event.inputs.skip_tests != true && github.event.inputs.skip_tests != 'true')
        id: coverage-check
        working-directory: ./apps/frontend
        run: |
          # Check if coverage meets threshold using Node.js (no external dependencies needed)
          # Coverage report is generated by the Unit Tests step above
          # Current threshold: 60%
          coverage=$(node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const coverage = data.total.lines.pct;
            const threshold = 60;
            if (coverage < threshold) {
              console.error(\`❌ Coverage \${coverage}% is below \${threshold}% threshold\`);
              process.exit(1);
            } else {
              console.log(\`✅ Coverage \${coverage}% meets \${threshold}% threshold\`);
              console.log(coverage);
            }
          ")
          echo "coverage=$coverage" >> $GITHUB_OUTPUT

      - name: Build Check
        if: (inputs.skip_build != true && inputs.skip_build != 'true') && (github.event.inputs.skip_build != true && github.event.inputs.skip_build != 'true')
        working-directory: ./apps/frontend
        run: npm run build

      - name: Upload Coverage
        if: (inputs.skip_tests != true && inputs.skip_tests != 'true') && (github.event.inputs.skip_tests != true && github.event.inputs.skip_tests != 'true')
        uses: codecov/codecov-action@v3
        with:
          file: ./apps/frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

      - name: Validate API
        uses: ./.github/actions/validate-api

      - name: Audit API Dependencies
        working-directory: ./api
        run: |
          echo "Running npm audit for API dependencies..."
          npm audit --audit-level=moderate || {
            echo "⚠️ npm audit found vulnerabilities. Review and address as needed."
            exit 1
          }
          echo "✅ npm audit passed"

      - name: Job Summary
        if: always()
        run: |
          echo "## Quality Gate Results (Node.js ${{ matrix.node-version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Node Version**: ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

      - name: Append Coverage to Summary
        if: always() && inputs.skip_tests != true && steps.coverage-check.outputs.coverage != ''
        run: |
          echo "- **Coverage**: ${{ steps.coverage-check.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
